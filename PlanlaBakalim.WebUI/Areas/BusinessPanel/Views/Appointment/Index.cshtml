@model AppointmentVM
@section Styles {
   
    <link href="~/BusinessPanel/css/appointments.css" rel="stylesheet" />
}

@Html.AntiForgeryToken()
<header class="app-header">
    <div class="header-top">
        <div class="header-left">
            <button class="back-btn" onclick="window.location.href='@Url.Action("Index", "Home", new { area = "BusinessPanel" })'">
                <i class="bi bi-arrow-left"></i>
            </button>
            <div class="header-title">
                <h1>Randevular</h1>
            </div>
        </div>

    </div>
</header>

<!-- Main Content -->
<main class="main-content">
    <div class="container">
        <!-- Compact Search and Filters -->
        <div class="search-filters">
            <div class="search-section">
                <i class="bi bi-search"></i>
                <input type="text" placeholder="Müşteri veya hizmet ara..." class="search-input" onkeypress="if(event.key==='Enter') searchAppointments()">
                <button class="search-btn" onclick="searchAppointments()">
                    <i class="bi bi-search"></i>
                </button>
            </div>
            <div class="filters-section">
                <select class="filter-dropdown" onchange="filterAppointments()">
                    <option value="">Tüm Durumlar</option>
                    <option value="confirmed">Onaylandı</option>
                    <option value="pending">Beklemede</option>
                    <option value="completed">Tamamlandı</option>
                </select>
                <select class="filter-dropdown" onchange="filterAppointments()">
                    <option value="">Tüm Tarihler</option>
                    <option value="today">Bugün</option>
                    <option value="tomorrow">Yarın</option>
                    <option value="week">Bu Hafta</option>
                </select>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-btn active" onclick="switchTab('active')">
                <i class="bi bi-calendar-check-fill"></i>
                <span>Aktif</span>
                <span class="tab-badge">@Model.ActiveAppointments.Count</span>
            </button>
            <button class="tab-btn" onclick="switchTab('past')">
                <i class="bi bi-clock-history"></i>
                <span>Geçmiş</span>
                <span class="tab-badge">@Model.PastAppointments.Count</span>
            </button>
        </div>

        <!-- Active Tab Content -->
        <div class="tab-content active" id="active-tab">

         
            <div class="search-results">
             
                @foreach (var appointment in Model.ActiveAppointments)
                {
                    var profileUrl = string.IsNullOrEmpty(appointment.User?.ProfileUrl)
                    ? "/img/UserProfile.jpg"
                    : appointment.User.ProfileUrl;
                    var statusClass = appointment.Status == AppointmentStatus.Confirmed ? "confirmed" : "pending";
                    var statusText = appointment.Status == AppointmentStatus.Confirmed ? "Onaylandı" : "Beklemede";
                   var iconClass = appointment.Status == AppointmentStatus.Confirmed ? "bi bi-check-circle-fill" : "bi bi-hourglass-split";


                    <div class="appointment-item @statusClass" id="appointment-@appointment.Id">
                        <div class="customer-avatar">
                            <img src="@profileUrl"
                                 alt="@(appointment.User != null ? appointment.User.FullName : appointment.GuestFullName)">
                        </div>
                        <div class="appointment-info">
                            <div class="customer-name">@(appointment.User != null ? appointment.User.FullName : appointment.GuestFullName)</div>
                            <div class="service-details">@appointment.AppointmentDate.ToString("dd MMM yyyy") - @appointment.AppointmentTime.ToString(@"hh\:mm")</div>
                            <div class="customer-phone">@(appointment.User!=null ? appointment.User.Phone : appointment.GuestPhone)</div>
                        </div>
                        <div class="appointment-status">
                            <span class="status-badge status-@statusClass">
                                <i class="@iconClass"></i>
                                @statusText
                            </span>
                        </div>
                        <div class="appointment-actions">
                            <button class="btn btn-primary btn-sm" onclick="callCustomer('@(appointment.User != null ? appointment.User.Phone : appointment.GuestPhone)')" title="Müşteriyi Ara">
                                <i class="bi bi-telephone-fill"></i>
                                Ara
                            </button>

                            @if(statusText=="Beklemede")
                            {
                                <button class="btn btn-success btn-sm" onclick="acceptAppointment(@appointment.Id)">
                                    <i class="bi bi-check-circle"></i>
                                    Onayla
                                </button>
                            }

                            <button class="btn btn-warning btn-sm" onclick="rejectAppointment(@appointment.Id)">
                                <i class="bi bi-calendar-x"></i> İptal Et
                            </button>


                            <button class="btn btn-info btn-sm" onclick="viewDetails(@appointment.Id)">
                                <i class="bi bi-eye"></i>
                                Detaylar
                            </button>
                        </div>
                    </div>
                }

            </div>
        </div>

        <div class="tab-content" id="past-tab">
            <div class="search-results">
        
                 @foreach (var appointment in Model.PastAppointments)
                  {
                        var profileUrl = string.IsNullOrEmpty(appointment.User?.ProfileUrl)
                        ? "/img/UserProfile.jpg"
                        : appointment.User.ProfileUrl;
                        var statusClass = appointment.Status switch
                        {
                            AppointmentStatus.Completed => "completed",
                            AppointmentStatus.Cancelled => "cancelled",
                            AppointmentStatus.Confirmed => "confirmed",
                            AppointmentStatus.Pending => "expired",
                            _ => "unknown"
                        };
                        var statusText = appointment.Status switch
                        {
                            AppointmentStatus.Completed => "Tamamlandı",
                            AppointmentStatus.Cancelled => "İptal Edildi",
                            AppointmentStatus.Confirmed => "Onaylandı",
                            AppointmentStatus.Pending => "Zamanı Geçmiş",
                            _ => "Bilinmeyen"
                        };
                        var iconClass = appointment.Status switch
                        {
                            AppointmentStatus.Completed => "bi bi-check-circle-fill",
                            AppointmentStatus.Cancelled => "bi bi-x-circle-fill",
                            AppointmentStatus.Confirmed => "bi bi-check-circle",
                            AppointmentStatus.Pending => "bi bi-clock-history",
                            _ => "bi bi-question-circle"
                        };
      

                    <div class="appointment-item @statusClass">
                            <div class="customer-avatar">
                                <img src="@profileUrl"
                                     alt="@(appointment.User != null ? appointment.User.FullName : appointment.GuestFullName)">
                            </div>
                            <div class="appointment-info">
                                <div class="customer-name">@(appointment.User != null ? appointment.User.FullName : appointment.GuestFullName)</div>
                                <div class="service-details">@appointment.AppointmentDate.ToString("dd MMM yyyy") - @appointment.AppointmentTime.ToString(@"hh\:mm")</div>
                                <div class="customer-phone">@(appointment.User != null ? appointment.User.Phone : appointment.GuestPhone)</div>
                            </div>
                            <div class="appointment-status">
                                <span class="status-badge status-@statusClass">
                                    <i class="@iconClass"></i>
                                    @statusText
                                </span>
                            </div>
                        <div class="appointment-actions">
                            <button class="btn btn-info btn-sm" onclick="viewDetails(@appointment.Id)">
                                <i class="bi bi-eye"></i>
                                Detaylar
                            </button>
                        </div>
                    </div>
                   }

            </div>
        </div>

      
        <!-- Appointment Details Modal -->
        <div class="modal fade" id="appointmentDetailsModal" tabindex="-1" aria-labelledby="appointmentDetailsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="appointmentDetailsModalLabel">Randevu Detayları</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
                    </div>
                    <div class="modal-body">
                        <div class="appointment-details-content">
                            <!-- Müşteri Bilgileri -->
                            <div class="customer-section d-flex align-items-center mb-3">
                                <div class="customer-avatar-large me-3">
                                    <img src="" alt="Müşteri" class="rounded-circle" id="appointment-avatar">
                                </div>
                                <div class="customer-info">
                                    <h4 class="customer-name-large"></h4>
                                    <p class="customer-phone-large"></p>
                                    <p class="customer-email"></p>
                                </div>
                            </div>

                            <!-- Randevu Bilgileri -->
                            <div class="appointment-details-section mb-3">
                                <h6>Randevu Bilgileri</h6>
                                <div class="detail-row">
                                    <span class="detail-label">Çalışan:</span>
                                    <span class="detail-value" id="appointment-employee"></span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Tarih:</span>
                                    <span class="detail-value" id="appointment-date"></span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Durum:</span>
                                    <span class="status-badge" id="appointment-status"></span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Hizmetler:</span>
                                    <div id="appointment-services"></div>
                                </div>
                            </div>

                            <!-- Notlar -->
                            <div class="notes-section">
                                <h6>Notlar</h6>
                                <p class="appointment-notes"></p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                    </div>
                </div>
            </div>
        </div>

</main>
<a class="fab" asp-area="BusinessPanel" asp-controller="Appointment" asp-action="Create" title="Yeni randevu">
    <i class="bi bi-plus-lg"></i>
</a>
@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/BusinessPanel/js/appointments.js"></script>
    @if (TempData["Notification"] != null)
    {
        <script>
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: '@TempData["NotificationType"]',
                title: '@TempData["Notification"]',
                showConfirmButton: false,
                timer: 2000,
                timerProgressBar: true
            });
        </script>
    }
}